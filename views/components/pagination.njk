{% macro pagination(itemCount, itemsPerPage, currentPage) %}
    {% from "govuk/components/pagination/macro.njk" import govukPagination %}

    {% set totalPages = (itemCount / itemsPerPage) | ceil %}
    {% set paginationArray = [] %}

    {% if totalPages <= 7 %}

        {% for i in range(1, totalPages + 1) -%}
            {% set rowArray = [] %}
            {% set isCurrent = (currentPage == i) %}
            {% set rowArray = { number: i, href: "?page=" + i, current: isCurrent } %}
            {% set paginationArray = (paginationArray.push(rowArray), paginationArray) %}
        {%- endfor %}

    {% else %}
        {% set paginationArray = (paginationArray.push({ number: 1, href: "?page=1", current: currentPage === 1 }), paginationArray) %}
        {% if (currentPage == 4) %}
            {% set paginationArray = (paginationArray.push({ number: 2, href: "?page=" + 2, current: 2 === currentPage }), paginationArray) %}
        {% elif (currentPage > 4) %}
            {% set paginationArray = (paginationArray.push({ ellipsis: true }), paginationArray) %}
        {% endif %}

        {% for i in range(currentPage - 1, currentPage + 2) -%}
          {% if (i > 1 and i < totalPages) %}
            {% set paginationArray = (paginationArray.push({ number: i, href: "?page=" + i, current: i === currentPage }), paginationArray) %}
          {% endif %}
        {%- endfor %}

        {% if (currentPage < totalPages - 2) %}
            {% set paginationArray = (paginationArray.push({ ellipsis: true }), paginationArray) %}
        {% endif %}

        {% set paginationArray = (paginationArray.push({ number: totalPages, href: "?page=" + totalPages, current: currentPage === totalPages }), paginationArray) %}
    {% endif %}

    {% if totalPages > 1 %}
        {% set nextHref = "" %}
        {% if currentPage < totalPages %}
            {% set nextHref = "?page=" + (currentPage + 1) %}
        {% endif %}

        {% set previousHref = "" %}
        {% if currentPage > 1 %}
            {% set previousHref = "?page=" + (currentPage - 1) %}
        {% endif %}

        {{ govukPagination({
            classes: "pagination-container",
            previous: {
                href: previousHref
            },
            next: {
                href: nextHref
            },
            items: paginationArray
        }) }}
    {% endif %}

{% endmacro %}
